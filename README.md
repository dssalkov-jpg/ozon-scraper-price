# Ozon Price Scraper

–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ü–µ–Ω –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ –Ω–∞ Ozon —Å —É—á—ë—Ç–æ–º —Ä–µ–≥–∏–æ–Ω–∞ –¥–æ—Å—Ç–∞–≤–∫–∏.

## –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏

- üõ°Ô∏è **Playwright Stealth** ‚Äî –æ–±—Ö–æ–¥ –±–∞–∑–æ–≤–æ–π –¥–µ—Ç–µ–∫—Ü–∏–∏ –±–æ—Ç–æ–≤
- üñ•Ô∏è **Xvfb** ‚Äî —Ä–µ–∞–ª—å–Ω—ã–π –±—Ä–∞—É–∑–µ—Ä (–Ω–µ headless) –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
- üé≠ **–ß–µ–ª–æ–≤–µ–∫–æ–ø–æ–¥–æ–±–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ** ‚Äî —Å–ª—É—á–∞–π–Ω—ã–µ –∑–∞–¥–µ—Ä–∂–∫–∏, —Å–∫—Ä–æ–ª–ª
- üîÑ **Retry —Å backoff** ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø–æ–≤—Ç–æ—Ä—ã –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
- üåç **–†–µ–≥–∏–æ–Ω–∞–ª—å–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª–∏** ‚Äî —Ä–∞–∑–Ω—ã–µ –ü–í–ó –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ü–µ–Ω
- üìä **JSON API** ‚Äî –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –≤–∞—à–∏–º–∏ —Å–∏—Å—Ç–µ–º–∞–º–∏

## –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### 1. –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞

```bash
cd ozon_price_scraper
cp .env.example .env
```

### 2. –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è —Ä–µ–≥–∏–æ–Ω–∞ (–Ω–∞ –ª–æ–∫–∞–ª—å–Ω–æ–π –º–∞—à–∏–Ω–µ —Å GUI)

```bash
python -m venv .venv
source .venv/bin/activate  # Windows: .venv\Scripts\activate
pip install -r requirements.txt
python -m playwright install chromium

python scripts/create_region_profile.py moscow_center
```

–í –æ—Ç–∫—Ä—ã–≤—à–µ–º—Å—è –±—Ä–∞—É–∑–µ—Ä–µ:
1. –í—ã–±–µ—Ä–∏ –≥–æ—Ä–æ–¥/–ü–í–ó
2. –ó–∞–∫—Ä–æ–π –±—Ä–∞—É–∑–µ—Ä

### 3. –ó–∞–ø—É—Å–∫ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

```bash
# –°–∫–æ–ø–∏—Ä—É–π –ø—Ä–æ—Ñ–∏–ª—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä
scp -r ./data/regions/moscow_center user@server:/path/to/app/data/regions/

# –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ
docker compose up --build -d
```

### 4. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

–û—Ç–∫—Ä–æ–π `http://your-server:8000`:

1. **Targets** ‚Äî –¥–æ–±–∞–≤—å URL —Ç–æ–≤–∞—Ä–æ–≤ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
2. **Regions** ‚Äî —Å–æ–∑–¥–∞–π –ø—Ä–æ—Ñ–∏–ª—å —Ä–µ–≥–∏–æ–Ω–∞ (—Å —Ç–µ–º –∂–µ –∏–º–µ–Ω–µ–º, —á—Ç–æ –ø–∞–ø–∫–∞)
3. **Runs** ‚Äî –∑–∞–ø—É—Å—Ç–∏ —Å–±–æ—Ä –≤—Ä—É—á–Ω—É—é –∏–ª–∏ –¥–æ–∂–¥–∏—Å—å –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫–∞ (01:00 UTC)

## API

### –ü–æ–ª—É—á–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Ü–µ–Ω—ã

```bash
curl http://localhost:8000/api/prices/latest
```

–û—Ç–≤–µ—Ç:
```json
{
  "run_id": 5,
  "collected_at": "2024-01-15T01:15:00",
  "items": [
    {
      "target_id": 1,
      "name": "–ö–æ–Ω–∫—É—Ä–µ–Ω—Ç –ê",
      "url": "https://ozon.ru/product/...",
      "price": 1599.00,
      "old_price": 1999.00,
      "card_price": 1499.00,
      "in_stock": true
    }
  ]
}
```

### –ü–æ–ª—É—á–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞

```bash
curl http://localhost:8000/runs/5/json
```

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (.env)

```bash
# –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
DATABASE_URL=sqlite:///./data/app.db

# –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ (UTC)
SCHEDULE_HOUR_UTC=1
SCHEDULE_MINUTE_UTC=0

# –ó–∞–¥–µ—Ä–∂–∫–∏ –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏ (–≤–∞–∂–Ω–æ –¥–ª—è –æ–±—Ö–æ–¥–∞ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫!)
MIN_DELAY_SECONDS=45
MAX_DELAY_SECONDS=120

# –ü—Ä–æ–∫—Å–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –Ω–æ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)
PROXY_URL=http://user:pass@proxy:port
```

## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### –ë–µ–∑ –ø—Ä–æ–∫—Å–∏ (—Ç–µ–∫—É—â–∞—è –≤–µ—Ä—Å–∏—è)

- ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è **–Ω–µ–±–æ–ª—å—à–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ç–æ–≤–∞—Ä–æ–≤** (–¥–æ 30-50/–¥–µ–Ω—å)
- ‚úÖ –ë–æ–ª—å—à–∏–µ –∑–∞–¥–µ—Ä–∂–∫–∏ –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏ (45-120 —Å–µ–∫)
- ‚ö†Ô∏è –ú–æ–∂–µ—Ç —Å–ª–æ–º–∞—Ç—å—Å—è —á–µ—Ä–µ–∑ –Ω–µ—Å–∫–æ–ª—å–∫–æ –¥–Ω–µ–π/–Ω–µ–¥–µ–ª—å
- ‚ö†Ô∏è –û–¥–∏–Ω IP = —Ä–∏—Å–∫ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏

### –° —Ä–µ–∑–∏–¥–µ–Ω—Ç–Ω—ã–º–∏ –ø—Ä–æ–∫—Å–∏ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

–î–æ–±–∞–≤—å `PROXY_URL` –≤ `.env`:
```bash
PROXY_URL=http://user:pass@proxy.bright.com:12345
```

–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã:
- Bright Data (~$10-15/GB)
- IPRoyal (~$7/GB)
- Smartproxy (~$8/GB)

–î–ª—è 100 —Ç–æ–≤–∞—Ä–æ–≤/–¥–µ–Ω—å –Ω—É–∂–Ω–æ ~1-2 GB/–º–µ—Å—è—Ü = $10-30.

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
ozon_price_scraper/
‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îú‚îÄ‚îÄ main.py          # FastAPI endpoints
‚îÇ   ‚îú‚îÄ‚îÄ models.py        # SQLAlchemy models
‚îÇ   ‚îú‚îÄ‚îÄ worker.py        # Scraping logic
‚îÇ   ‚îú‚îÄ‚îÄ scheduler.py     # APScheduler jobs
‚îÇ   ‚îî‚îÄ‚îÄ templates/       # Jinja2 templates
‚îú‚îÄ‚îÄ scripts/
‚îÇ   ‚îî‚îÄ‚îÄ create_region_profile.py
‚îú‚îÄ‚îÄ data/
‚îÇ   ‚îú‚îÄ‚îÄ app.db           # SQLite database
‚îÇ   ‚îî‚îÄ‚îÄ regions/         # Browser profiles
‚îú‚îÄ‚îÄ Dockerfile
‚îú‚îÄ‚îÄ docker-compose.yml
‚îî‚îÄ‚îÄ requirements.txt
```

## Troubleshooting

### "price_not_found" –¥–ª—è –≤—Å–µ—Ö —Ç–æ–≤–∞—Ä–æ–≤

Ozon –æ–±–Ω–æ–≤–∏–ª —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Å—Ç—Ä–∞–Ω–∏—Ü—ã. –ù—É–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å —Å–µ–ª–µ–∫—Ç–æ—Ä—ã –≤ `worker.py`.

### –ë—ã—Å—Ç—Ä—ã–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏

1. –£–≤–µ–ª–∏—á—å `MIN_DELAY_SECONDS` –¥–æ 60-90
2. –î–æ–±–∞–≤—å —Ä–µ–∑–∏–¥–µ–Ω—Ç–Ω—ã–µ –ø—Ä–æ–∫—Å–∏
3. –£–±–µ–¥–∏—Å—å, —á—Ç–æ –ø—Ä–æ—Ñ–∏–ª—å —Ä–µ–≥–∏–æ–Ω–∞ —Å–æ–∑–¥–∞–Ω –Ω–∞ —Ç–æ–π –∂–µ –û–°

### –ë—Ä–∞—É–∑–µ—Ä –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

–ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ Xvfb —Ä–∞–±–æ—Ç–∞–µ—Ç:
```bash
docker compose logs | grep Xvfb
```

## –õ–∏—Ü–µ–Ω–∑–∏—è

MIT
# deploy test Thu Feb 12 10:55:03 UTC 2026
